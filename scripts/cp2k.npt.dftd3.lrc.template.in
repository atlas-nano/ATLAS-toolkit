@SET MD_SAVE_FREQ  1
@SET LA LA_HERE
@SET LB LB_HERE
@SET LC LC_HERE
@SET ALPHA ALPHA_HERE
@SET BETA BETA_HERE
@SET GAMMA GAMMA_HERE
@SET RTEMP TEMP_HERE
@SET PREFIX PREFIX_HERE
@SET NSTEPS 10000
@SET TSTEP 0.5
@SET CP2K_HOME /global/home/users/tpascal/codes/cp2k/cp2k

&GLOBAL
 PRINT_LEVEL low
 PROJECT ${PREFIX}.${RTEMP}K
 RUN_TYPE MD
 WALLTIME 36000000
&END GLOBAL

&MOTION
 &CELL_OPT
  EXTERNAL_PRESSURE 1.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 1.0
  KEEP_ANGLES TRUE
  OPTIMIZER BFGS
  TYPE MD
  &PRINT
   &CELL
    FILENAME ./${PREFIX}.${RTEMP}K
    &EACH
     CELL_OPT ${MD_SAVE_FREQ}
    &END EACH
   &END CELL
  &END PRINT
 &END CELL_OPT

 &PRINT
  &VELOCITIES
   FILENAME ./${PREFIX}.${RTEMP}K
   FORMAT XYZ
   &EACH
     MD ${MD_SAVE_FREQ}
   &END EACH
  &END VELOCITIES
  &TRAJECTORY
   FILENAME ./${PREFIX}.${RTEMP}K
   FORMAT XYZ
   &EACH
     MD ${MD_SAVE_FREQ}
   &END EACH
  &END TRAJECTORY
 &END PRINT

 &MD
  ENSEMBLE NPT_F
  STEPS ${NSTEPS}
  TIMESTEP ${TSTEP}
  TEMPERATURE ${RTEMP}
  COMVEL_TOL 1e-8

  &THERMOSTAT
   REGION GLOBAL
   TYPE CSVR
   &CSVR
    TIMECON 100
   &END CSVR
  &END THERMOSTAT

  &BAROSTAT
   PRESSURE 1.0000
   TIMECON 500
   VIRIAL XYZ
  &END BAROSTAT
 &END MD
&END MOTION

&FORCE_EVAL
 METHOD Quickstep
 &DFT
  CHARGE 0
  MULTIPLICITY 1
  WFN_RESTART_FILE_NAME ${PREFIX}.${RTEMP}K-RESTART.wfn
  BASIS_SET_FILE_NAME ${CP2K_HOME}/data/GTH_BASIS_SETS
  POTENTIAL_FILE_NAME ${CP2K_HOME}/data/GTH_POTENTIALS
  &MGRID
   CUTOFF [Ry] 240
  &END MGRID
  &PRINT
   &MULLIKEN
    FILENAME ./${PREFIX}.${RTEMP}K
    &EACH
     MD 1
    &END EACH
   &END MULLIKEN
  &END PRINT

  &QS
   EPS_DEFAULT 1.0E-12
   EXTRAPOLATION ASPC
   EXTRAPOLATION_ORDER 3
   MAP_CONSISTENT
   METHOD GPW
  &END QS
  &SCF
   EPS_SCF 1.0E-5
   MAX_SCF 50
   SCF_GUESS RESTART

   &OUTER_SCF
    EPS_SCF 1.0E-5
    MAX_SCF 20
   &END OUTER_SCF

   &OT
    MINIMIZER DIIS
    PRECONDITIONER FULL_ALL
   &END OT   
  &END SCF
  &XC
   &XC_FUNCTIONAL PBE
    &PBE
      PARAMETRIZATION REVPBE
    &END PBE
   &END XC_FUNCTIONAL
   &vdW_POTENTIAL
    DISPERSION_FUNCTIONAL PAIR_POTENTIAL
    &PAIR_POTENTIAL
     TYPE DFTD3
     CALCULATE_C9_TERM .TRUE.
     PARAMETER_FILE_NAME ${CP2K_HOME}/data/dftd3.dat
     REFERENCE_FUNCTIONAL PBE
     VERBOSE_OUTPUT
     R_CUTOFF 8.
     EPS_CN 0.01
     LONG_RANGE_CORRECTION
    &END PAIR_POTENTIAL
   &END vdW_POTENTIAL
  &END XC

  &POISSON
   PERIODIC XYZ
   POISSON_SOLVER PERIODIC
  &END POISSON
 &END DFT
 &SUBSYS
  &CELL
   ABC ${LA} ${LB} ${LC}
   ALPHA_BETA_GAMMA ${ALPHA} ${BETA} ${GAMMA}
   PERIODIC XYZ
  &END CELL

  &COORD
   @INCLUDE ${PREFIX}.cp2k.xyz
  &END COORD
  KIND_HERE
 &END SUBSYS
 STRESS_TENSOR ANALYTICAL
&END FORCE_EVAL
